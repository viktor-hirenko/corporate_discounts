# 🚀 Инструкция по деплою Corporate Discounts

## Предварительные требования

- ✅ Все Secrets настроены в Cloudflare Worker
- ✅ Worker задеплоен (`npm run deploy:worker`)
- ✅ Локальное тестирование пройдено

---

## ⚠️ ВАЖНО: Content-Code Separation

С версии 1.3.0 реализовано **разделение деплоя кода и контента**:

- **Код** (HTML, CSS, JS) деплоится через `npm run deploy`
- **Контент** (партнеры, категории) обновляется **только через админку**
- `data/app-config.json` **НЕ перезаписывается** при деплое

### Почему это важно?

Раньше при деплое затирались все изменения, сделанные контент-менеджерами в админке. Теперь:

- ✅ Разработчик деплоит код → контент не трогается
- ✅ Контент-менеджер работает в админке → деплои не затирают данные
- ✅ При локальной разработке → автоматически синхронизируется актуальный конфиг

---

## Деплой Production

### 1. Синхронизация конфига (для локальной разработки)

```bash
npm run sync:config
```

Загружает актуальный `app-config.json` с production. Выполняется **автоматически** при `npm run dev`.

### 2. Сборка проекта

```bash
npm run build
```

Проверит TypeScript, оптимизирует изображения, соберет токены дизайна, создаст production build в `dist/`.

### 3. Деплой статических файлов на R2

```bash
npm run deploy:r2
```

Загрузит `dist/` на Cloudflare R2 bucket **БЕЗ** `data/app-config.json`.

⚠️ **Важно:** Контент (партнеры, категории) не будет перезаписан!

### 4. Деплой Worker (если были изменения)

```bash
npm run deploy:worker
```

Обновит Cloudflare Worker с новым кодом.

### 5. Полный деплой (все вместе)

```bash
npm run deploy
```

Выполнит все 3 шага автоматически: build → deploy:r2 → deploy:worker

**Результат:** Код обновлен, контент остался без изменений.

---

## Деплой конфига (редко!)

### Когда нужно?

- Изменилась структура `app-config.json` в коде
- Нужно добавить новые поля
- Требуется перезаписать production конфиг локальным

### Команда

```bash
npm run deploy:config
```

⚠️ **ВНИМАНИЕ:** Эта команда **ПЕРЕЗАПИШЕТ** production конфиг!

Все изменения, сделанные контент-менеджерами в админке, будут **ПОТЕРЯНЫ**!

**Процесс:**

1. Показывает количество партнеров в локальном конфиге
2. Запрашивает подтверждение (нужно ввести `yes`)
3. Загружает локальный конфиг на R2

**Пример:**

```
╔════════════════════════════════════════════════════════════╗
║  ⚠️  УВАГА: ПРИМУСОВИЙ ДЕПЛОЙ app-config.json              ║
╠════════════════════════════════════════════════════════════╣
║  Ця операція ПЕРЕЗАПИШЕ production конфіг!                 ║
║  Всі зміни, зроблені контент-менеджерами в адмінці,       ║
║  будуть ВТРАЧЕНІ!                                          ║
╚════════════════════════════════════════════════════════════╝

📊 Локальний конфіг:
   Партнерів: 56
   Файл: src/data/app-config.json

Введіть 'yes' для підтвердження деплою: _
```

---

## URLs Production

- **Сайт (через Worker)**: https://corporate-discounts-worker.upstars-marbella.workers.dev
- **R2 Direct URL**: https://pub-37aeae40035e428e93ab550125107a2d.r2.dev
- **Админка**: https://corporate-discounts-worker.upstars-marbella.workers.dev/#/admin/partners

---

## Как работает сохранение на Production

1. Админка определяет что запущена на production (не localhost)
2. Все API запросы идут через Worker URL: `https://corporate-discounts-worker.upstars-marbella.workers.dev/api/*`
3. Worker обрабатывает запросы:
   - `GET /api/load-config` → читает `data/app-config.json` из R2
   - `POST /api/save-config` → сохраняет `data/app-config.json` в R2
   - `POST /api/upload-image` → загружает изображения партнеров в R2
4. Изменения сохраняются в R2 и доступны после обновления страницы

### Content-Code Separation

```
┌─────────────────────────────────────────────────────────┐
│                 РАЗРАБОТЧИК                             │
├─────────────────────────────────────────────────────────┤
│  npm run dev      → Автосинхронизация + запуск dev     │
│  npm run deploy   → Деплой КОДА без контента           │
│  npm run deploy:config → Примусовий деплой конфігу     │
└─────────────────────────────────────────────────────────┘
                          ↑↓
┌─────────────────────────────────────────────────────────┐
│                 CLOUDFLARE R2                           │
│  /data/app-config.json  ← Обновляется только через     │
│                            админку или deploy:config   │
└─────────────────────────────────────────────────────────┘
                          ↑↓
┌─────────────────────────────────────────────────────────┐
│              КОНТЕНТ-МЕНЕДЖЕР                           │
├─────────────────────────────────────────────────────────┤
│  Работает в админке → Изменения сохраняются в R2       │
│  Деплои разработчика НЕ ЗАТИРАЮТ ее изменения!         │
└─────────────────────────────────────────────────────────┘
```

---

## Проверка после деплоя

1. Открой админку на production:

   ```
   https://corporate-discounts-worker.upstars-marbella.workers.dev/#/admin/partners
   ```

2. Залогинься через Google

3. Создай тестового партнера или измени существующего

4. Нажми "Зберегти зміни на сервер"

5. Обнови страницу (`Cmd+R` / `Ctrl+R`)

6. ✅ Изменения должны остаться!

---

## Troubleshooting

### Изменения не сохраняются

1. Проверь что Worker Secrets настроены:
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`
   - `GOOGLE_CLIENT_SECRET`

2. Проверь Worker Logs:
   ```bash
   cd worker && npm run tail
   ```

### 403/404 ошибки

- Проверь что R2 bucket name совпадает в `worker/wrangler.toml`
- Проверь что AWS credentials верные

### CORS ошибки

- Worker автоматически добавляет CORS headers
- Проверь `worker/src/index.ts` → `corsHeaders`

---

## Custom Domain (опционально)

Если хочешь использовать свой домен вместо `*.workers.dev`:

1. Cloudflare Dashboard → Workers & Pages → corporate-discounts-worker
2. **Settings** → **Triggers** → **Add Custom Domain**
3. Введи свой домен (например, `discounts.upstars.com`)
4. Cloudflare автоматически настроит DNS

---

**Готово! 🎉**
